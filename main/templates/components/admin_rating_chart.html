<!-- Gráfico de pacotes filtrados por média de avaliação (estático para teste) -->
<div class="card shadow mb-4">
  <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
    <h6 class="m-0 font-weight-bold text-primary">Pacotes filtrados por média de avaliação</h6>
  </div>
  <div class="card-body">
    <div class="chart-pie pt-4 pb-2">
      <canvas id="ratingChart" style="width:100%; height:260px; max-height:260px;"></canvas>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  if (typeof Chart === 'undefined') return;

  const ctx = document.getElementById('ratingChart');
  if (!ctx) return;

  // Read counts from template context (aval1..aval5). Order: 5,4,3,2,1
  const values = [
    parseInt('{{ aval5|default:"0"|escapejs }}') || 0,
    parseInt('{{ aval4|default:"0"|escapejs }}') || 0,
    parseInt('{{ aval3|default:"0"|escapejs }}') || 0,
    parseInt('{{ aval2|default:"0"|escapejs }}') || 0,
    parseInt('{{ aval1|default:"0"|escapejs }}') || 0
  ];

  const maxVal = Math.max(...values);
  let stepSize = 1;
  if (maxVal <= 10) stepSize = 1;
  else if (maxVal <= 20) stepSize = 2;
  else if (maxVal <= 50) stepSize = 5;
  else stepSize = 10;

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['5★', '4★', '3★', '2★', '1★'],
      datasets: [{
        label: 'Número de pacotes',
        data: values,
        backgroundColor: '#4e73df',
        borderColor: '#2e59d9',
        borderWidth: 1,
        barThickness: 18,
        borderRadius: 6,
      }]
    },
      options: {
      indexAxis: 'y', // horizontal bars
      maintainAspectRatio: false,
      scales: {
        x: {
          beginAtZero: true,
          ticks: { stepSize: stepSize }
        },
        y: {
          grid: { display: false }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.parsed.x + ' pacotes';
            }
          }
        }
      }
    }
  });
});
</script>
