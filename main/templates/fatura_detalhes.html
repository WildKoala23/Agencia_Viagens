{% extends "base.html" %}
{% load static %}

{% block title %}Detalhes da Fatura #{{ fatura.fatura_id }}{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'utils.css' %}">
<link rel="stylesheet" href="{% static 'fatura_utils.css' %}">
{% endblock %}

{% block page_title %}Detalhes da Fatura{% endblock %}

{% block content %}
<div class="container_utils">

    {% if error %}
    <div class="card_utils">
        <div class="alert_utils alert-error">
            <h3>Erro!</h3>
            <p>{{ error }}</p>
            <a href="{% url 'faturas' %}" class="btn_save_utils" style="margin-top: 15px;">Voltar às Faturas</a>
        </div>
    </div>
    {% else %}
    
    <div class="card_utils">
        <div class="invoice-header">
            <div>
                <h1>Fatura #{{ fatura.fatura_id }}</h1>
                <p style="margin: 0; color: #6c757d;">Data de Emissão: {{ fatura.data_emissao|date:"d/m/Y H:i" }}</p>
            </div>
            <div>
                {% if fatura.estado_pagamento == 'Pago' %}
                    <span class="badge badge-success">PAGO</span>
                {% elif fatura.estado_pagamento == 'Pendente' %}
                    <span class="badge badge-warning">PENDENTE</span>
                {% elif fatura.estado_pagamento == 'Falhado' %}
                    <span class="badge badge-danger">FALHADO</span>
                {% else %}
                    <span class="badge badge-secondary">{{ fatura.estado_pagamento|upper }}</span>
                {% endif %}
            </div>
        </div>

        <div class="grid-2-cols">
            <div class="info-section">
                <h4>Informações do Cliente</h4>
                <p><strong>Nome:</strong> {{ fatura.nome_cliente }}</p>
                <p><strong>Email:</strong> {{ fatura.email }}</p>
                <p><strong>ID Cliente:</strong> #{{ fatura.user_id }}</p>
            </div>

            <div class="info-section">
                <h4>Informações de Pagamento</h4>
                <p><strong>ID Compra:</strong> #{{ fatura.compra_id }}</p>
                <p><strong>ID Pagamento:</strong> 
                    {% if fatura.pagamento_id %}
                        #{{ fatura.pagamento_id }}
                    {% else %}
                        <span style="color: #6c757d;">Sem pagamento associado</span>
                    {% endif %}
                </p>
                <p><strong>Tipo de Pagamento:</strong> 
                    {% if fatura.tipo_pagamento %}
                        <span class="badge badge-info">{{ fatura.tipo_pagamento }}</span>
                    {% else %}
                        <span style="color: #6c757d;">N/A</span>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <div class="card_utils">
        <h2 style="color: #17a2b8;">Itens da Fatura</h2>
        
        <div style="overflow-x: auto;">
            <table class="items-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Pacote</th>
                        <th>Destino</th>
                        <th>Descrição</th>
                        <th style="text-align: right;">Preço</th>
                        <th style="text-align: right;">Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    {% for linha in linhas %}
                    <tr>
                        <td>{{ linha.fatura_linha_id }}</td>
                        <td><strong>{{ linha.nome_pacote }}</strong></td>
                        <td><span class="badge badge-secondary">{{ linha.destino_nome }}</span></td>
                        <td>
                            {% if linha.descricao_item %}
                                {{ linha.descricao_item }}
                            {% else %}
                                <small style="color: #6c757d;">{{ linha.descricao_pacote|truncatewords:10 }}</small>
                            {% endif %}
                        </td>
                        <td style="text-align: right;">{{ linha.preco }}€</td>
                        <td style="text-align: right; font-weight: 600;">{{ linha.subtotal }}€</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 30px;">
                            <div class="empty_state_utils">
                                Nenhum item encontrado nesta fatura.
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="total-section">
            <h3>Resumo</h3>
            <p><strong>Total de Itens:</strong> {{ linhas|length }}</p>
            <h2><strong>Total a Pagar: {{ fatura.valor_total }}€</strong></h2>
        </div>

        <div class="action-buttons">
            <a href="{% url 'faturas' %}" class="edit_btn_utils">← Voltar às Faturas</a>
        </div>
    </div>

    {% endif %}

</div>
{% endblock %}
